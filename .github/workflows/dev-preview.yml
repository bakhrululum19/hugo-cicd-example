name: Preview Deploy

on:
  push:
    branches:
      - dev

concurrency:
  group: preview-${{ github.ref }}
  cancel-in-progress: true

env:
  HUGO_VERSION: "0.152.2"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source (with theme submodule)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
      
      - uses: ./.github/actions/hugo-build
        with:
          hugo-version: ${{ env.HUGO_VERSION }}
          build-args: --buildDrafts --buildFuture --minify

      - name: Upload preview artifact
        uses: actions/upload-artifact@v4
        with:
          name: preview-site
          path: public
          retention-days: 7

      - name: Deploy preview
        if: false # TODO: enable when we have a deploy key
        uses: ./.github/actions/remote-deploy
        with:
          deploy-key: ${{ secrets.DEPLOY_KEY }}
          deploy-host: ${{ secrets.DEPLOY_HOST }}
          remote-path: preview/hugo-cicd-example/
          deploy-environment: preview