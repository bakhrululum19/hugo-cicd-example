name: Promote Dev to Production

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "⚠️ deploy to production"
        type: boolean
        required: true
        default: false

env:
  HUGO_VERSION: "0.152.2"

jobs:
  promote-and-deploy:
    if: ${{ github.event.inputs.confirm == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout main (with submodules)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine target commit
        id: target
        run: |
          git fetch origin dev
          TARGET_SHA=$(git rev-parse origin/dev)
          echo "Target SHA: $TARGET_SHA"
          echo "sha=$TARGET_SHA" >> $GITHUB_OUTPUT

      - name: Fast-forward main to dev
        run: |
          git checkout main
          git merge --ff-only ${{ steps.target.outputs.sha }}
          git push origin HEAD:main

      - name: Build production site
        uses: ./.github/actions/hugo-build
        with:
          hugo-version: ${{ env.HUGO_VERSION }}

      - name: Upload production artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-site
          path: public
          retention-days: 7

      - name: Deploy production
        if: false # TODO: enable when we have a deploy key
        uses: ./.github/actions/remote-deploy
        with:
          deploy-key: ${{ secrets.DEPLOY_KEY }}
          deploy-host: ${{ secrets.DEPLOY_HOST }}
          remote-path: prod/hugo-cicd-example/
          deploy-environment: prod